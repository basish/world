<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>World Guessing Game</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="game-container">
    <h1>Guess the Countries of the World</h1>
    <div id="controls">
        <input type="text" id="name-input" placeholder="Your Name" required />
        <button id="start-btn" disabled>Start</button>
        <button id="pause-btn" disabled>Pause</button>
        <button id="end-btn" disabled>End Game</button>
        <span id="timer">15:00</span>
        <input type="text" id="guess-input" placeholder="Type a country..." disabled />
        <span>Guessed: <span id="guessed-count">0/197</span></span>
    </div>
    <div id="continent-stats" style="margin-bottom:10px;"></div><!-- Added to show continent counts -->
    <div id="map-container">
        <svg id="map"></svg>
    </div>

    <div id="leaderboard-container">
        <h2>Leaderboard</h2>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Countries Guessed</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
////////////////////
// Configuration
const TIMER_DURATION = 15 * 60; // 15 minutes
let timeRemaining = TIMER_DURATION;
let timerInterval = null;
let isPaused = false;
let isGameOver = false;
let userName = "";
let gameStartTime = null; 
let currentUserTemp = null; 
let previousUserRank = null; // track old rank

let countries = [];
let guessedCountries = new Set();
const totalCountries = 197;

const abbreviations = {
    "usa": "United States of America",
    "uk": "United Kingdom",
    "uae": "United Arab Emirates",
    "car": "Central African Republic",
    "drc": "Democratic Republic of the Congo"
};

// Define 7 continents
const allContinents = ["Africa","Asia","Europe","North America","South America","Oceania","Antarctica"];

// continentCounts and continentTotals
let continentCounts = {};
let continentTotals = {};
allContinents.forEach(cont => {
    continentCounts[cont] = 0;
    continentTotals[cont] = 0;
});

// You must provide a mapping from country name to continent
// Example (fill in properly):
// const continents = {
//   "United States of America": "North America",
//   "France": "Europe",
//   ...
// };
const continents = {};

// Update continent stats display
function updateContinentStats() {
    let html = '';
    allContinents.forEach(cont => {
        const got = continentCounts[cont] || 0;
        const tot = continentTotals[cont] || 0;
        html += `<span style="margin-right:10px;">${cont}: ${got}/${tot}</span>`;
    });
    document.getElementById('continent-stats').innerHTML = html;
}

const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const endBtn = document.getElementById('end-btn');
const timerSpan = document.getElementById('timer');
const guessInput = document.getElementById('guess-input');
const guessedCountSpan = document.getElementById('guessed-count');
const nameInput = document.getElementById('name-input');

const svg = d3.select("#map");
const width = 1200;
const height = 600;

const projection = d3.geoMercator().scale(130).translate([width / 2, height / 2]);
const path = d3.geoPath().projection(projection);

let currentTransform = d3.zoomIdentity;
const zoom = d3.zoom()
    .scaleExtent([1, 20])
    .on("zoom", (event) => {
        currentTransform = event.transform;
        g.attr("transform", currentTransform);
    });

const g = svg.append("g");

// Load leaderboard
let leaderboard = loadLeaderboard();

// Event listeners
nameInput.addEventListener('input', () => {
    startBtn.disabled = !nameInput.value.trim();
});

startBtn.addEventListener("click", startGame);
pauseBtn.addEventListener("click", togglePause);
endBtn.addEventListener("click", endGameEarly);
guessInput.addEventListener("input", handleGuess);

document.addEventListener('keydown', () => {
    if (!isPaused && !isGameOver) guessInput.focus();
});

// Load your world.geojson as before
d3.json("world.geojson").then(data => {
    countries = data.features.map(d => ({
        name: d.properties.ADMIN,
        feature: d
    }));

    // Compute continent totals
    countries.forEach(c => {
        const cont = continents[c.name];
        if (cont && allContinents.includes(cont)) {
            continentTotals[cont] = (continentTotals[cont] || 0) + 1;
        }
    });
    updateContinentStats();

    g.selectAll("path")
     .data(data.features)
     .enter().append("path")
     .attr("class", "country")
     .attr("d", path);

    svg.call(zoom);
});

function startGame() {
    userName = nameInput.value.trim();
    if (!userName) return;
    startBtn.disabled = true;
    guessInput.disabled = false;
    pauseBtn.disabled = false;
    endBtn.disabled = false;
    guessInput.value = '';
    guessInput.focus();
    gameStartTime = Date.now();

    startTimer();
}

function togglePause() {
    if (isGameOver) return;
    isPaused = !isPaused;
    if (isPaused) {
        pauseTimer();
        guessInput.disabled = true;
        pauseBtn.textContent = "Unpause";
    } else {
        resumeTimer();
        guessInput.disabled = false;
        guessInput.focus();
        pauseBtn.textContent = "Pause";
    }
}

function pauseTimer() {
    clearInterval(timerInterval);
}

function resumeTimer() {
    startTimer();
}

function startTimer() {
    clearInterval(timerInterval);
    updateTimerDisplay();
    timerInterval = setInterval(() => {
        if (!isPaused) {
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                endGame();
            }
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    timerSpan.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
}

function handleGuess() {
    if (isPaused || isGameOver) return;
    let currentGuess = guessInput.value.trim().toLowerCase();

    if (abbreviations[currentGuess]) {
        currentGuess = abbreviations[currentGuess].toLowerCase();
    }

    const matchedCountry = countries.find(c =>
        c.name && c.name.toLowerCase() === currentGuess && !guessedCountries.has(c.name)
    );

    if (matchedCountry) {
        guessedCountries.add(matchedCountry.name);
        animateCountryGuess(matchedCountry);
        guessInput.value = '';
        guessedCountSpan.textContent = `${guessedCountries.size}/${totalCountries}`;

        // Update continent count if known
        const cont = continents[matchedCountry.name];
        if (cont && allContinents.includes(cont)) {
            continentCounts[cont] = (continentCounts[cont] || 0) + 1;
            updateContinentStats();
        }

        updateLeaderboardEntry();
    }
}

// Adjusted font size to be 25% smaller than previous stable code
function computeFontSize(feature) {
    const bounds = path.bounds(feature);
    const boxWidth = bounds[1][0] - bounds[0][0];
    const boxHeight = bounds[1][1] - bounds[0][1];

    const rawFontSize = Math.min(boxWidth, boxHeight) / 50;
    const scaledFontSize = rawFontSize * 0.7; 
    const finalFontSize = scaledFontSize * 0.8 * 0.75; // 20% smaller * additional 25% smaller
    return Math.max(Math.min(finalFontSize, 12), 4);
}

function animateCountryGuess(country) {
    const sel = g.selectAll("path")
      .filter(d => d.properties.ADMIN === country.name);

    // Initial lighter green and fade over 1.8s
    sel
      .transition().duration(0)
      .style("fill", "#c0ffc0")
      .transition().duration(1800)
      .style("fill", "#90EE90")
      .on("end", () => {
          sel.classed("highlighted", true);
      });

    const fontSize = computeFontSize(country.feature);
    const centroid = path.centroid(country.feature);
    g.append("text")
     .attr("class", "country-label")
     .attr("x", centroid[0])
     .attr("y", centroid[1])
     .attr("font-size", fontSize + "px")
     .text(country.name);
}

function endGame() {
    if (isGameOver) return;
    isGameOver = true;
    guessInput.disabled = true;
    pauseBtn.disabled = true;
    endBtn.disabled = true;
    clearInterval(timerInterval);

    const missingCountries = countries.filter(c => !guessedCountries.has(c.name));
    missingCountries.forEach(m => {
        const fontSize = computeFontSize(m.feature); 
        const centroid = path.centroid(m.feature);
        g.append("text")
          .attr("class", "country-label missed-label")
          .attr("x", centroid[0])
          .attr("y", centroid[1])
          .attr("font-size", fontSize + "px")
          .text(m.name);

        g.selectAll("path")
         .filter(d => d.properties.ADMIN === m.name)
         .classed("missed", true);
    });

    const totalGuessed = guessedCountries.size;
    const totalTimeTaken = (TIMER_DURATION - timeRemaining);

    addToLeaderboard(userName, totalGuessed, totalTimeTaken);
}

function endGameEarly() {
    if (isGameOver) return;
    timeRemaining = 0;
    endGame();
}

// Leaderboard Functions
function loadLeaderboard() {
    const data = localStorage.getItem("world_game_leaderboard");
    return data ? JSON.parse(data) : [];
}

function saveLeaderboard() {
    localStorage.setItem("world_game_leaderboard", JSON.stringify(leaderboard));
}

function addToLeaderboard(name, countriesGuessed, timeTaken) {
    const entry = {
        name: name,
        date: new Date().toLocaleString([], {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
        countriesGuessed: countriesGuessed,
        timeTaken: timeTaken
    };

    leaderboard.push(entry);
    sortLeaderboard();
    trimLeaderboard();
    saveLeaderboard();
    renderLeaderboard();
}

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
}

function sortLeaderboard() {
    leaderboard.sort((a, b) => {
        if (b.countriesGuessed === a.countriesGuessed) {
            return a.timeTaken - b.timeTaken;
        }
        return b.countriesGuessed - a.countriesGuessed;
    });
}

function trimLeaderboard() {
    if (leaderboard.length > 15) {
        leaderboard = leaderboard.slice(0,15);
    }
}

function renderLeaderboard(highlightEntry=null) {
    const tbody = document.querySelector("#leaderboard tbody");
    tbody.innerHTML = '';

    leaderboard.forEach((entry, i) => {
        const tr = document.createElement('tr');
        const rank = i+1;
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${entry.name}</td>
          <td>${entry.date}</td>
          <td>${entry.countriesGuessed}</td>
          <td>${formatTime(entry.timeTaken)}</td>
        `;
        if (highlightEntry === entry) {
            tr.classList.add('leaderboard-highlight');
        }
        tbody.appendChild(tr);
    });
}

function getUserRank(entry) {
    const idx = leaderboard.indexOf(entry);
    return idx >= 0 ? idx+1 : Infinity;
}

function updateLeaderboardEntry() {
    const countriesGuessedNow = guessedCountries.size;
    const timeTaken = Math.floor((Date.now() - gameStartTime) / 1000);

    if (!currentUserTemp) {
        currentUserTemp = {
            name: userName,
            date: new Date().toLocaleString([], {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
            countriesGuessed: countriesGuessedNow,
            timeTaken: timeTaken,
            isTemp: true
        };
        leaderboard.push(currentUserTemp);
    } else {
        currentUserTemp.countriesGuessed = countriesGuessedNow;
        currentUserTemp.timeTaken = timeTaken;
    }

    const oldRank = getUserRank(currentUserTemp);
    sortLeaderboard();
    trimLeaderboard();
    const newRank = getUserRank(currentUserTemp);

    let highlightEntry = null;
    if (previousUserRank !== null && newRank < previousUserRank) {
        highlightEntry = currentUserTemp;
    }
    previousUserRank = newRank;

    renderLeaderboard(highlightEntry);
}

// Non-countries often included in world data might include:
// - Hong Kong (a SAR of China)
// - Puerto Rico (US territory)
// - Greenland (part of Denmark)
// - Western Sahara (disputed territory)
// - French Guiana (overseas department of France)
// - Bermuda, Cayman Islands, etc. (overseas territories)
// Check your GeoJSON data to identify which appear.
</script>
</body>
</html>
